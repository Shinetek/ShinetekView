{"version":3,"sources":["FirePointKML.js"],"names":[],"mappings":"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","file":"FirePointKML-compiled.js","sourcesContent":["/**\r\n * Created by liuym on 2017/1/22.\r\n */\r\n\r\nvar fs = require(\"fs\");\r\nvar ftp = require(\"ftp\");\r\nvar ftpInfo = require(\"../config.json\");\r\n\r\n/**\r\n * 通过FTP目录进行 火点数据获取\r\n * @param req\r\n * @param res\r\n * @param next\r\n * @constructor\r\n */\r\nvar GetKMLFile = function (req, res, next) {\r\n    console.log('GetKMLFile');\r\n\r\n    //修改为kml格式的头  res.setHeader(\"Access-Control-Allow-Origin\",\"*\");\r\n    res.setHeader('Content-Type', 'application/vnd.google-earth.kml+xml', \"Access-Control-Allow-Origin\", \"*\", 'Access-Control-Allow-Headers\",\"X-Requested-With');\r\n\r\n    //api字段检验\r\n    var sat = req.params.sat;\r\n    var sensor = req.params.sensor;\r\n\r\n    var DateParam = req.params.date;\r\n    var fullname = req.params.fullname;\r\n\r\n    /* if (DateParam.length < 12) {\r\n     res.end('Date format should be YYYYMMDDHHMM !');\r\n     }*/\r\n    var dateFormat = DateParam.substring(0, 8) + '_' + DateParam.substring(8, 12);\r\n\r\n    //连接ftp，获取文件信息\r\n    var clientFTP = new ftp();\r\n    clientFTP.connect({\r\n        host: ftpInfo.FirePointFTP.host,\r\n        port: ftpInfo.FirePointFTP.port,\r\n        user: ftpInfo.FirePointFTP.uid,\r\n        password: ftpInfo.FirePointFTP.pw,\r\n        connTimeout: '2000'\r\n    });\r\n\r\n    clientFTP.on('error', function (err) {\r\n        if (err) {\r\n            console.log(err);\r\n            if (clientFTP != null) {\r\n                clientFTP.end();\r\n                clientFTP.destroy();\r\n                clientFTP = null;\r\n                console.log('err成功关闭连接ftp:' + ftpInfo.FirePointFTP.host + '!');\r\n            }\r\n        }\r\n    });\r\n\r\n    var data = null;\r\n    clientFTP.on('ready', function () {\r\n        console.log('ready成功连接至ftp:' + ftpInfo.FirePointFTP.host + '!');\r\n\r\n        //方法一： 根据参数sat sensor date来拼接KML文件名称\r\n        //clientFTP.list(ftpInfo.FirePointFTP.path + '*'+sat+'*'+sensor+'*'+dateFormat+'*.KML',function (err,list){\r\n        //    if(err) {\r\n        //        console.log(err);\r\n        //\r\n        //        if(clientFTP!=null){\r\n        //            clientFTP.end();\r\n        //            clientFTP.destroy();\r\n        //            clientFTP=null;\r\n        //            console.log('err已断开连接'+ftpInfo.FirePointFTP.host+'!');\r\n        //        }\r\n        //\r\n        //        res.end('Get KML file error! '+err);\r\n        //    }\r\n        //    else\r\n        //    {\r\n        //        if(Boolean(list) && list.length==1){\r\n        //\r\n        //            clientFTP.get(ftpInfo.FirePointFTP.path +list[0].name, function (err, stream) {\r\n        //                console.log(list[0].name);\r\n        //                if (err) {\r\n        //                    console.log(err);\r\n        //\r\n        //                    if(clientFTP!=null){\r\n        //                        clientFTP.end();\r\n        //                        clientFTP.destroy();\r\n        //                        clientFTP=null;\r\n        //                        console.log('err已断开连接'+ftpInfo.FirePointFTP.host+'!');\r\n        //                    }\r\n        //\r\n        //                    res.end('Get KML file error! '+err);\r\n        //                }\r\n        //                stream.on('data',function(chunk){\r\n        //                    if(data==null){\r\n        //                        data ='';\r\n        //                    }\r\n        //                    data += chunk;\r\n        //                });\r\n        //\r\n        //                stream.once('end', function () {\r\n        //                    console.log('参数： '+sat+' '+sensor+ ' '+DateParam+ ' '+fullname);\r\n        //\r\n        //                    if(clientFTP!=null){\r\n        //                        clientFTP.end();\r\n        //                        clientFTP.destroy();\r\n        //                        clientFTP=null;\r\n        //                        console.log('ready已断开连接'+ftpInfo.FirePointFTP.host+'!');\r\n        //                    }\r\n        //                    res.end(data);\r\n        //                });\r\n        //                // stream.pipe(fs.createWriteStream(localPath + '/' + timeTableName));\r\n        //            });\r\n        //\r\n        //        }else{\r\n        //            res.end('Get KML file error! '+err);\r\n        //        }\r\n        //    }\r\n        //});\r\n\r\n        //方法二： 根据参数fullname来直接读取KML文件\r\n        clientFTP.get(ftpInfo.FirePointFTP.path + fullname, function (err, stream) {\r\n            console.log(ftpInfo.FirePointFTP.path + fullname);\r\n            if (err) {\r\n                console.log(err);\r\n\r\n                if (clientFTP != null) {\r\n                    clientFTP.end();\r\n                    clientFTP.destroy();\r\n                    clientFTP = null;\r\n                    console.log('err已断开连接' + ftpInfo.FirePointFTP.host + '!');\r\n\r\n                }\r\n\r\n                res.end('Get KML file error! ' + err);\r\n            }\r\n            stream.on('data', function (chunk) {\r\n                if (data == null) {\r\n                    data = '';\r\n                }\r\n                data += chunk;\r\n            });\r\n\r\n            stream.once('end', function () {\r\n                console.log('参数： ' + sat + ' ' + sensor + ' ' + DateParam + ' ' + fullname);\r\n\r\n                if (clientFTP != null) {\r\n                    clientFTP.end();\r\n                    clientFTP.destroy();\r\n                    clientFTP = null;\r\n                    console.log('ready已断开连接' + ftpInfo.FirePointFTP.host + '!');\r\n                }\r\n                res.end(data);\r\n                // res.end(data);\r\n            });\r\n            // stream.pipe(fs.createWriteStream(localPath + '/' + timeTableName));\r\n        });\r\n\r\n    });\r\n\r\n    next();\r\n};\r\n\r\nexports._GetKMLFile = GetKMLFile;\r\n\r\n/**\r\n * 通过本地文件目录进行火点文件获取\r\n * @param req\r\n * @param res\r\n * @param next\r\n * @constructor\r\n */\r\nvar GetKMLFilebyPath = function (req, res, next) {\r\n    console.log('GetKMLFilebyPath');\r\n    //修改为kml格式的头  res.setHeader(\"Access-Control-Allow-Origin\",\"*\");\r\n    res.setHeader('Content-Type',\r\n\r\n        'application/vnd.google-earth.kml+xml',\r\n        \"Access-Control-Allow-Origin\", \"*\",\r\n        'Access-Control-Allow-Headers\",\"X-Requested-With');\r\n\r\n    //api字段检验\r\n    var sat = req.params.sat;\r\n    var sensor = req.params.sensor;\r\n\r\n    var DateParam = req.params.date;\r\n    var fullname = req.params.fullname;\r\n\r\n\r\n    //连接ftp，获取文件信息\r\n\r\n    var m_kmldata = null;\r\n    var FilePath = ftpInfo.FirePointFTP.path + fullname;\r\n    var exist = fs.existsSync(FilePath);\r\n    console.log(exist);\r\n    console.log(FilePath);\r\n    m_kmldata = fs.readFileSync(FilePath);\r\n    console.log(m_kmldata);\r\n    res.end(m_kmldata);\r\n    next();\r\n};\r\n\r\nexports._GetKMLFilebyPath = GetKMLFilebyPath;\r\n"]}